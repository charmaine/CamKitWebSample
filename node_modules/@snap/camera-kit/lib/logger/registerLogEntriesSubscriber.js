import { filter } from "rxjs";
import { stringifyError } from "../common/errorHelpers";
import { configurationToken } from "../configuration";
import { Injectable } from "../dependency-injection/Injectable";
import { getPlatformInfo } from "../platform/platformInfo";
import { logEntriesFactory } from "./logEntries";
import { logLevelMap } from "./logger";
/**
 * The factory subscribes to log entry events and, based on the configured log level,
 * forwards matching log entries to the logger specified in the CameraKit configuration object.
 *
 * @internal
 */
export const registerLogEntriesSubscriber = Injectable("registerLogEntriesSubscriber", [configurationToken, logEntriesFactory.token], (configuration, logEntries) => {
    logEntries
        .pipe(filter((entry) => logLevelMap[entry.level] >= logLevelMap[configuration.logLevel]))
        .subscribe((logEntry) => {
        switch (configuration.logger) {
            case "console":
                // Chrome doesn't print the `cause` Error property, so we need to manually construct a complete
                // stack trace using our `stringifyError` helper.
                const messages = getPlatformInfo().browser.brand === "Chrome"
                    ? logEntry.messages.map((message) => {
                        if (!(message instanceof Error))
                            return message;
                        message.stack = stringifyError(message);
                        return message;
                    })
                    : logEntry.messages;
                console[logEntry.level](`[CameraKit.${logEntry.module}]`, ...messages);
                break;
        }
    });
});
//# sourceMappingURL=registerLogEntriesSubscriber.js.map