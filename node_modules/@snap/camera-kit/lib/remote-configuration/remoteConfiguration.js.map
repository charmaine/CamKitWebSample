{"version":3,"file":"remoteConfiguration.js","sourceRoot":"","sources":["../../src/remote-configuration/remoteConfiguration.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,IAAI,EAAE,GAAG,EAAE,QAAQ,EAAE,UAAU,EAAE,WAAW,EAAE,IAAI,EAAE,MAAM,MAAM,CAAC;AAC1E,OAAO,EAAgD,kBAAkB,EAAE,MAAM,kBAAkB,CAAC;AACpG,OAAO,EAAE,UAAU,EAAE,MAAM,oCAAoC,CAAC;AAGhE,OAAO,EAAE,SAAS,EAAE,MAAM,gDAAgD,CAAC;AAE3E,OAAO,EAAE,mCAAmC,EAAgB,MAAM,aAAa,CAAC;AAChF,OAAO,EAAE,iBAAiB,EAAE,MAAM,cAAc,CAAC;AAEjD,MAAM,uBAAuB,GAAoC;IAC7D,UAAU,EAAE,CAAC,SAAS,CAAC,SAAS,EAAE,SAAS,CAAC,eAAe,EAAE,SAAS,CAAC,gBAAgB,CAAC;CAC3F,CAAC;AAEF,MAAM,4BAA4B,GAAG,8DAA8D,CAAC;AAMpG,MAAM,OAAO,mBAAmB;IAI5B,YACI,eAA0D,EAC1D,WAAiC,EACjC,UAAgD,EAChD,YAA0B;QAE1B,MAAM,WAAW,GAAG,OAAO,CAAC,OAAO,CAAC,eAAe,CAAC,CAAC,IAAI,CAAC,CAAC,eAAe,EAAE,EAAE;YAC1E,sFAAsF;YACtF,OAAO,CAAA,eAAe,aAAf,eAAe,uBAAf,eAAe,CAAE,OAAO,MAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,eAAe,aAAf,eAAe,uBAAf,eAAe,CAAE,OAAO,CAAC;QACjF,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC,IAAI;QACpC,2GAA2G;QAC3G,2GAA2G;QAC3G,yGAAyG;QACzG,oCAAoC;QACpC,QAAQ,CAAC,CAAC,gBAAgB,EAAE,EAAE,CAC1B,IAAI,CACA,UAAU,iCACH,uBAAuB,KAC1B,gBAAgB,IAClB,CACL,CACJ,EACD,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE;YACX,MAAM,UAAU,GAAG,IAAI,GAAG,EAA0B,CAAC;YACrD,MAAM,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,MAAM,EAAE,EAAE;;gBACpC,MAAM,aAAa,GAAG,MAAA,UAAU,CAAC,GAAG,CAAC,MAAM,CAAC,QAAQ,CAAC,mCAAI,EAAE,CAAC;gBAC5D,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;gBAC3B,UAAU,CAAC,GAAG,CAAC,MAAM,CAAC,QAAQ,EAAE,aAAa,CAAC,CAAC;YACnD,CAAC,CAAC,CAAC;YACH,OAAO,UAAU,CAAC;QACtB,CAAC,CAAC,EACF,WAAW,CAAC,CAAC,CAAC,CACjB,CAAC;QAEF,IAAI,CAAC,oBAAoB,GAAG,IAAI,UAAU,CAAuB,CAAC,QAAQ,EAAE,EAAE;YAC1E,YAAY,CAAC,WAAW,WAAW,GAAG,4BAA4B,EAAE,CAAC;iBAChE,IAAI,CAAC,CAAC,QAAQ,EAAE,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;iBACnC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE;gBACX,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACpB,QAAQ,CAAC,QAAQ,EAAE,CAAC;YACxB,CAAC,CAAC;iBACD,KAAK,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;QAC7C,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;IAC5B,CAAC;IAED;;OAEG;IACH,GAAG,CAAC,QAAgB;QAChB,OAAO,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE,WAAC,OAAA,MAAA,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,mCAAI,EAAE,CAAA,EAAA,CAAC,CAAC,CAAC;IAC7E,CAAC;IAED;;OAEG;IACH,uBAAuB;QACnB,OAAO,IAAI,CAAC,oBAAoB,CAAC;IACrC,CAAC;IAED,YAAY,CAAC,SAA8B;QACvC,OAAO,IAAI,CAAC,UAAU,CAAC,IAAI,CACvB,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE;YACZ,MAAM,gBAAgB,GAAG,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;iBAChD,MAAM,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS,KAAK,SAAS,CAAC,CAAC;iBACjE,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,CAAC;YAEnC,OAAO,gBAAgB,CAAC;QAC5B,CAAC,CAAC,CACL,CAAC;IACN,CAAC;CACJ;AAED,MAAM,CAAC,MAAM,0BAA0B,GAAG,UAAU,CAChD,qBAAqB,EACrB,CAAC,kBAAkB,EAAE,iBAAiB,CAAC,KAAK,EAAE,mCAAmC,CAAC,KAAK,CAAU,EACjG,CACI,MAA8B,EAC9B,UAAgD,EAChD,YAA0B,EACP,EAAE;IACrB,MAAM,YAAY,GAAG,IAAI,mBAAmB,CACxC,MAAM,CAAC,eAAe,EACtB,MAAM,CAAC,WAAW,EAClB,UAAU,EACV,YAAY,CACf,CAAC;IAEF,+GAA+G;IAC/G,sGAAsG;IACtG,YAAY,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC;IAE/C,OAAO,YAAY,CAAC;AACxB,CAAC,CACJ,CAAC","sourcesContent":["import { from, map, mergeMap, Observable, shareReplay, take } from \"rxjs\";\nimport { CameraKitApiHostname, CameraKitConfiguration, configurationToken } from \"../configuration\";\nimport { Injectable } from \"../dependency-injection/Injectable\";\nimport { ConfigTargetingRequest } from \"../generated-proto/pb_schema/cdp/cof/config_request\";\nimport { ConfigResult } from \"../generated-proto/pb_schema/cdp/cof/config_result\";\nimport { Namespace } from \"../generated-proto/pb_schema/cdp/cof/namespace\";\nimport { GetInitializationConfigResponse } from \"../generated-proto/pb_schema/camera_kit/v3/service\";\nimport { cameraKitServiceFetchHandlerFactory, FetchHandler } from \"../handlers\";\nimport { cofHandlerFactory } from \"./cofHandler\";\n\nconst defaultTargetingRequest: Partial<ConfigTargetingRequest> = {\n    namespaces: [Namespace.LENS_CORE, Namespace.CAMERA_KIT_CORE, Namespace.LENS_CORE_CONFIG],\n};\n\nconst initializeConfigRelativePath = \"/com.snap.camerakit.v3.Metrics/metrics/initialization_config\";\n\ntype SupportedNamespaces = Namespace.LENS_CORE | Namespace.CAMERA_KIT_CORE | Namespace.LENS_CORE_CONFIG;\n\nexport type InitializationConfig = GetInitializationConfigResponse;\n\nexport class RemoteConfiguration {\n    private readonly configById: Observable<Map<string, ConfigResult[]>>;\n    private readonly initializationConfig: Observable<InitializationConfig>;\n\n    constructor(\n        lensPerformance: CameraKitConfiguration[\"lensPerformance\"],\n        apiHostname: CameraKitApiHostname,\n        cofHandler: ReturnType<typeof cofHandlerFactory>,\n        fetchHandler: FetchHandler\n    ) {\n        const lensCluster = Promise.resolve(lensPerformance).then((lensPerformance) => {\n            // `0` means no cluster could be determined. For COF, we'll omit a value in that case.\n            return lensPerformance?.cluster === 0 ? undefined : lensPerformance?.cluster;\n        });\n\n        this.configById = from(lensCluster).pipe(\n            // Note: we don't catch errors here, purposefully letting them propagate to subscribers outside this class.\n            // Subscribers, having more context about the config use-case, will know better how to handle an error than\n            // we do here (e.g. their logging / reporting will have more context, and they can use the error they get\n            // from this Observable as a cause).\n            mergeMap((lensClusterOrig4) =>\n                from(\n                    cofHandler({\n                        ...defaultTargetingRequest,\n                        lensClusterOrig4,\n                    })\n                )\n            ),\n            map((result) => {\n                const configById = new Map<string, ConfigResult[]>();\n                result.configResults.forEach((config) => {\n                    const configsWithId = configById.get(config.configId) ?? [];\n                    configsWithId.push(config);\n                    configById.set(config.configId, configsWithId);\n                });\n                return configById;\n            }),\n            shareReplay(1)\n        );\n\n        this.initializationConfig = new Observable<InitializationConfig>((observer) => {\n            fetchHandler(`https://${apiHostname}${initializeConfigRelativePath}`)\n                .then((response) => response.json())\n                .then((data) => {\n                    observer.next(data);\n                    observer.complete();\n                })\n                .catch((err) => observer.error(err));\n        }).pipe(shareReplay(1));\n    }\n\n    /**\n     * COF configuration.\n     */\n    get(configId: string): Observable<ConfigResult[]> {\n        return this.configById.pipe(map((config) => config.get(configId) ?? []));\n    }\n\n    /**\n     * Configuration that is provided by Camera Kit backend.\n     */\n    getInitializationConfig(): Observable<InitializationConfig> {\n        return this.initializationConfig;\n    }\n\n    getNamespace(namespace: SupportedNamespaces): Observable<ConfigResult[]> {\n        return this.configById.pipe(\n            map((configs) => {\n                const namespaceConfigs = Array.from(configs.values())\n                    .filter((values) => values.some((c) => c.namespace === namespace))\n                    .flatMap((results) => results);\n\n                return namespaceConfigs;\n            })\n        );\n    }\n}\n\nexport const remoteConfigurationFactory = Injectable(\n    \"remoteConfiguration\",\n    [configurationToken, cofHandlerFactory.token, cameraKitServiceFetchHandlerFactory.token] as const,\n    (\n        config: CameraKitConfiguration,\n        cofHandler: ReturnType<typeof cofHandlerFactory>,\n        fetchHandler: FetchHandler\n    ): RemoteConfiguration => {\n        const remoteConfig = new RemoteConfiguration(\n            config.lensPerformance,\n            config.apiHostname,\n            cofHandler,\n            fetchHandler\n        );\n\n        // We'll kick off remote configuration loading by subscribing (and then unsubscribing) to a dummy config value.\n        // Subsequent requests for config will use the shared Observable, benefitting from this eager loading.\n        remoteConfig.get(\"\").pipe(take(1)).subscribe();\n\n        return remoteConfig;\n    }\n);\n"]}