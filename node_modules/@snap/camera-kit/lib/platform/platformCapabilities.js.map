{"version":3,"file":"platformCapabilities.js","sourceRoot":"","sources":["../../src/platform/platformCapabilities.ts"],"names":[],"mappings":"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","sourcesContent":["import { exceptions, simd } from \"wasm-feature-detect\";\nimport { memoize } from \"../common/memoize\";\nimport { XrCapabilities } from \"../lens-core-module\";\nimport { platformNotSupportedError } from \"../namedErrors\";\nimport { getPlatformInfo } from \"./platformInfo\";\n\n/** @internal */\nexport type SupportedCapability<T> = T & { supported: true };\n/** @internal */\nexport type UnsupportedCapability = { supported: false; error: Error };\n/** @internal */\nexport type Capability<T = void> = SupportedCapability<T> | UnsupportedCapability;\n\n//-----------\n// WebGL\n//-----------\n\ntype WebGlCapability = Capability<{ maxTextureSize: number }>;\n\n// This required minimum max texture size is based on data from\n// https://web3dsurvey.com/webgl/parameters/MAX_TEXTURE_SIZE. Checking for a reasonable minimum MAX_TEXTURE_SIZE avoids\n// attempting to run lenses on platforms that will not support them -- most commonly, we've seen some platforms that\n// report 0 MAX_TEXTURE_SIZE, which will cause errors for all lenses.\nconst minRequiredMaxTextureSize = 1024;\n\n/**\n * @returns An object with fields describing support for various WebGL features.\n *\n * @internal\n */\nfunction getWebGlSupport(): WebGlCapability {\n    const ctx = document.createElement(\"canvas\").getContext(\"webgl2\");\n    if (!ctx)\n        return {\n            supported: false,\n            error: platformNotSupportedError(\"CameraKit requires WebGL2, but this browser does not support WebGL2.\"),\n        };\n    const maxTextureSize = ctx.getParameter(ctx.MAX_TEXTURE_SIZE);\n    const supported = maxTextureSize >= minRequiredMaxTextureSize;\n    return supported\n        ? { supported, maxTextureSize }\n        : {\n              supported,\n              error: platformNotSupportedError(\n                  `CameraKit requires WebGL's MAX_TEXTURE_SIZE exceed a minimum value of ` +\n                      `${minRequiredMaxTextureSize}, but the browser's reported MAX_TEXTURE_SIZE is ${maxTextureSize}.`\n              ),\n          };\n}\n\n//-----------\n// WASM\n//-----------\n\ntype WasmCapability = Capability<{ wasmFeatures: number }>;\n\n/**\n * Because there may be a large number of WASM-related capabilities, and because these may correspond to various builds\n * of LensCore, we encode the various WASM capabilities into a single number by bitwise OR-ing together the numbers\n * corresponding to each capability.\n *\n * Since each combindation of capabilities is represented by a single number, we can easily map between that number and\n * the corresponding LensCore build name that makes use of those capabilities.\n *\n * @internal\n */\nexport enum WasmFeatures {\n    Default = 0b00000000,\n    SIMD = 0b00000001,\n    ExceptionHandling = 0b00000010,\n}\n\n/**\n * @returns A non-negative integer representing the combination of supported WebAssembly features, or -1 if WebAssembly\n * is not supported at all.\n *\n * @internal\n */\nasync function getWebAssemblyCapabilities(): Promise<WasmCapability> {\n    if (globalThis.WebAssembly === undefined)\n        return {\n            supported: false,\n            error: platformNotSupportedError(\n                \"CameraKit requires WebAssembly, but this browser does not support WebAssembly.\"\n            ),\n        };\n    return {\n        supported: true,\n        wasmFeatures: (\n            await Promise.all([\n                simd().then((supported) => {\n                    // Although Safari 16.4 reports SIMD support, LensCore encounters rendering bugs when using\n                    // SIMD in Safari 16.4. We will disable SIMD for now until Safari stabilizes the feature.\n                    if (getPlatformInfo().browser.brand === \"Safari\") return WasmFeatures.Default;\n                    return supported ? WasmFeatures.SIMD : WasmFeatures.Default;\n                }),\n                exceptions().then((supported) => (supported ? WasmFeatures.ExceptionHandling : WasmFeatures.Default)),\n            ])\n        ).reduce((features, feature) => features | feature, WasmFeatures.Default),\n    };\n}\n\n//-----------\n// WebXR\n//-----------\n\ntype WebXrCapability = Capability<XrCapabilities>;\n\n/**\n * @returns A Promise containing an object with fields describing the support of various WebXR features. This object's\n * type is defined by LensCore, as they consume these capabilities and adjust behavior accordingly.\n *\n * @internal\n */\nasync function getWebXrCapabilities(): Promise<WebXrCapability> {\n    const notSupported: WebXrCapability = {\n        supported: false,\n        error: platformNotSupportedError(\n            `Use of this feature requires WebXR support for immersive AR sessions, but ` +\n                `this browser does not support immersive AR sessions.`\n        ),\n    };\n    if (!isSecureContext) return notSupported;\n    if (!navigator.xr) return notSupported;\n    const isImmersiveArSupported = await navigator.xr.isSessionSupported(\"immersive-ar\");\n    return isImmersiveArSupported\n        ? {\n              supported: true,\n              sixDofSupported: true,\n              sceneDepthSupported: true,\n          }\n        : notSupported;\n}\n\n/** @internal */\nexport interface PlatformCapabilities {\n    webgl: WebGlCapability;\n    wasm: WasmCapability;\n    webxr: WebXrCapability;\n}\n\n/**\n * Get information about the current platform capabilities, including:\n * - WebGL support and various WebGL parameters.\n * - WASM support and support for various WASM features.\n * - WebXR support and support for various WebXR features.\n *\n * @internal\n */\nexport const getPlatformCapabilities = memoize(async function getPlatformCapabilities(): Promise<PlatformCapabilities> {\n    return {\n        webgl: getWebGlSupport(),\n        wasm: await getWebAssemblyCapabilities(),\n        webxr: await getWebXrCapabilities(),\n    };\n});\n"]}